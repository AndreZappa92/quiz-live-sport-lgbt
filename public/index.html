<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pride House Quiz - CIG Arcigay Milano</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        body { -webkit-tap-highlight-color: transparent; }
        .text-justify { text-align: justify; text-justify: inter-word; }
    </style>
</head>
<body class="bg-gray-50 overflow-x-hidden select-none font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment } = React;

        // --- COMPONENTE ICONE (Ridisegnate con precisione geometrica per evitare distorsioni) ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                trophy: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6V3h12v1h1.5a2.5 2.5 0 0 1 0 5H18v3c0 4-3 7-7 7H9c-4 0-7-3-7-7V9z"/>
                        <path d="M12 17v4"/><path d="M8 21h8"/>
                    </g>
                ),
                users: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </g>
                ),
                play: <path d="m7 4 12 8-12 8V4z" fill="currentColor"/>,
                chevronRight: <path d="m9 18 6-6-6-6" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                checkCircle: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <path d="M22 4L12 14.01l-3-3"/>
                    </g>
                ),
                xCircle: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="m15 9-6 6"/><path d="m9 9 6 6"/>
                    </g>
                ),
                crown: <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7z" fill="currentColor"/>,
                clock: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                    </g>
                ),
                zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor"/>,
                coins: (
                    <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M8 6c0 1.66-3.58 3-8 3s-8-1.34-8-3 3.58-3 8-3 8 1.34 8 3z" transform="translate(12, 4)"/>
                        <path d="M4 6v6c0 1.66 3.58 3 8 3s8-1.34 8-3V6" transform="translate(0, 0)"/>
                        <path d="M4 12v6c0 1.66 3.58 3 8 3s8-1.34 8-3v-6" transform="translate(0, 0)"/>
                    </g>
                ),
                smile: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></g>,
                qr: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/></g>,
                loader2: <g fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></g>
            };
            return (
                <svg viewBox="0 0 24 24" width={size} height={size} className={`${className} flex shrink-0`} style={{ display: 'inline-block', verticalAlign: 'middle' }}>
                    {icons[name] || null}
                </svg>
            );
        };

        const LogoArcigay = ({ className }) => (
            <img src="/logoCIG.png" alt="Logo CIG" className={className} onError={(e) => {
                e.target.onerror = null; 
                e.target.src = "https://www.arcigaymilano.org/wp-content/themes/arcigay-milano/assets/images/logo.png";
            }} />
        );

        const LogoPrideHouse = ({ className }) => (
            <img src="/logo_ph.png" alt="Logo Pride House" className={className} />
        );

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDOWS0ZMGxhj6ATL6FFycR-DATvuYug3WM",
            authDomain: "quiz-live-sport-lgbt.firebaseapp.com",
            projectId: "quiz-live-sport-lgbt",
            storageBucket: "quiz-live-sport-lgbt.firebasestorage.app",
            messagingSenderId: "741735100972",
            appId: "1:741735100972:web:6040adbb5b040257931789",
            measurementId: "G-47N6SFEWZG"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'quiz-lgbt-sport-2026';
        const TIMER_SECONDS = 30;

        // --- DATI QUIZ ---
        const QUIZ_DATA = {
            title: "Sport e Inclusione: LGBT+",
            questions: [
                {
                    id: 1,
                    question: "In quale città e in quale anno si sono tenuti i primi Gay Games, l'evento multisportivo internazionale dedicato alla comunità LGBT+?",
                    options: [
                        { text: "Amsterdam, 1998", rationale: "Amsterdam ha ospitato un'edizione molto famosa, ma non è stata la città d'esordio.", isCorrect: false },
                        { text: "San Francisco, 1982", rationale: "Fondati da Tom Waddell, l'obiettivo era promuovere lo spirito di inclusione e partecipazione attraverso lo sport.", isCorrect: true },
                        { text: "New York, 1969", rationale: "Il 1969 è l'anno dei moti di Stonewall, ma la prima manifestazione sportiva ufficiale arrivò oltre un decennio dopo.", isCorrect: false },
                        { text: "Londra, 1975", rationale: "Sebbene Londra sia attiva nell'attivismo, i primi giochi nacquero sulla costa occidentale degli Uniti.", isCorrect: false }
                    ]
                },
                {
                    id: 2,
                    question: "Chi è stato il primo calciatore professionista in attività a fare coming out nel 1990?",
                    options: [
                        { text: "Thomas Hitzlsperger", rationale: "L'ex centrocampista della Lazio ha fatto coming out solo dopo il ritiro dall'attività agonistica.", isCorrect: false },
                        { text: "Justin Fashanu", rationale: "Fu un pioniere assoluto nel calcio inglese, purtroppo affrontando enormi pregiudizi per la sua scelta.", isCorrect: true },
                        { text: "Jakub Jankto", rationale: "Jankto è uno dei pochi calciatori moderni ad averlo fatto in attività, ma molti anni dopo il 1990.", isCorrect: false },
                        { text: "Robbie Rogers", rationale: "Rogers fece coming out nel 2013, diventando un simbolo per la MLS americana.", isCorrect: false }
                    ]
                },
                {
                    id: 3,
                    question: "L'atleta Laurel Hubbard ha segnato la storia delle Olimpiadi di Tokyo 2020 per quale motivo?",
                    options: [
                        { text: "È stata la prima donna transgender a competere in una gara individuale", rationale: "La sua partecipazione nel sollevamento pesi ha aperto un importante dibattito globale sull'inclusività e le regole sportive.", isCorrect: true },
                        { text: "Ha vinto la prima medaglia d'oro per una persona non binaria", rationale: "Sebbene sia stata una pioniera, non ha raggiunto il podio durante quell'edizione dei Giochi.", isCorrect: false },
                        { text: "È stata la portabandiera della squadra dei rifugiati", rationale: "Questo ruolo è stato ricoperto da altri atleti; la Hubbard rappresentava la Nuova Zelanda.", isCorrect: false },
                        { text: "Ha stabilito un record mondiale nel lancio del disco", rationale: "La Hubbard gareggiava nella categoria del sollevamento pesi, non nell'atletica leggera.", isCorrect: false }
                    ]
                },
                {
                    id: 4,
                    question: "Quale icona del tennis mondiale ha vinto 18 titoli del Grande Slam ed è stata una delle prime atlete d'élite a vivere apertamente la propria omosessualità?",
                    options: [
                        { text: "Billie Jean King", rationale: "Anche lei è un'icona dei diritti, ma il suo coming out pubblico è avvenuto in circostanze diverse rispetto alla Navratilova.", isCorrect: false },
                        { text: "Chris Evert", rationale: "Storica rivale della Navratilova, la Evert non appartiene alla comunità LGBT+.", isCorrect: false },
                        { text: "Martina Navratilova", rationale: "Oltre ai successi in campo, è diventata una delle più influenti attiviste per i diritti LGBT+ nel mondo dello sport.", isCorrect: true },
                        { text: "Steffi Graf", rationale: "La tennista tedesca ha dominato gli anni '90 ma non è nota per attivismo legato alla comunità LGBT+.", isCorrect: false }
                    ]
                },
                {
                    id: 5,
                    question: "La calciatrice Megan Rapinoe è famosa non solo per i suoi successi in campo, ma anche per il suo attivismo. Quale premio ha vinto nel 2019?",
                    options: [
                        { text: "Pallone d'Oro femminile", rationale: "In quell'anno ha trascinato gli USA alla vittoria del Mondiale, diventando un simbolo globale di lotta per l'uguaglianza.", isCorrect: true },
                        { text: "Premio Oscar per il miglior documentario", rationale: "Sebbene sia apparsa in molti media, non ha mai vinto un premio dell'Academy cinematografica.", isCorrect: false },
                        { text: "Medaglia d'oro nel nuoto sincronizzato", rationale: "La Rapinoe è esclusivamente una calciatrice professionista.", isCorrect: false },
                        { text: "Sindaco della città di Seattle", rationale: "È molto amata a Seattle, ma non ha mai ricoperto cariche politiche elettive.", isCorrect: false }
                    ]
                },
                {
                    id: 6,
                    question: "Durante i Mondiali di calcio in Qatar 2022, quale simbolo di supporto alla comunità LGBT+ è stato al centro di una disputa tra FIFA e diverse nazionali europee?",
                    options: [
                        { text: "La fascia da capitano 'OneLove'", rationale: "La FIFA proibì l'uso della fascia arcobaleno minacciando sanzioni sportive ai capitani che l'avessero indossata.", isCorrect: true },
                        { text: "Le scarpe con i tacchetti glitterati", rationale: "Non c'è stata alcuna polemica specifica riguardante le calzature dei giocatori in quel senso.", isCorrect: false },
                        { text: "Il fumo colorato arcobaleno negli stadi", rationale: "L'uso di fumogeni è vietato per motivi di sicurezza, indipendentemente dal colore.", isCorrect: false },
                        { text: "Il cambio del nome della competizione in 'Gay Cup'", rationale: "Il nome della competizione è rimasto FIFA World Cup senza alcuna proposta di modifica.", isCorrect: false }
                    ]
                },
                {
                    id: 7,
                    question: "Chi è il tuffatore britannico, oro olimpico a Tokyo 2020, che usa la sua visibilità per normalizzare il coming out e combattere l'omofobia?",
                    options: [
                        { text: "Tom Daley", rationale: "Oltre ai tuffi, è amatissimo per la sua passione per l'uncinetto e per il suo impegno costante nel sociale.", isCorrect: true },
                        { text: "Matthew Mitcham", rationale: "Mitcham è stato un grande campione australiano, ma il riferimento al bronzo olimpico e alla passione per l'uncinetto è tipico di Daley.", isCorrect: false },
                        { text: "Greg Louganis", rationale: "Louganis è una leggenda del passato (anni '80), mentre l'atleta in questione è contemporaneo.", isCorrect: false },
                        { text: "Ian Thorpe", rationale: "Thorpe è un nuotatore (non un tuffatore) e ha fatto coming out dopo la fine della carriera.", isCorrect: false }
                    ]
                },
                {
                    id: 8,
                    question: "Quale di questi è lo scopo principale degli 'EuroGames'?",
                    options: [
                        { text: "Selezionare gli atleti per le prossime Olimpiadi", rationale: "Gli EuroGames non sono un evento di qualificazione olimpica ufficiale.", isCorrect: false },
                        { text: "Gareggiare esclusivamente per vincere premi in denaro", rationale: "Lo spirito dell'evento è sociale e comunitario, non basato su grandi premi monetari.", isCorrect: false },
                        { text: "Contrastare la discriminazione e sostenere l'integrazione LGBT+ nello sport", rationale: "Si tratta di un evento multisportivo europeo aperto a tutti, indipendentemente dall'orientamento sessuale.", isCorrect: true },
                        { text: "Permettere la partecipazione solo ad atleti professionisti", rationale: "L'evento è aperto ad atleti di ogni livello, dai dilettanti ai professionisti.", isCorrect: false }
                    ]
                },
                {
                    id: 9,
                    question: "Nel 2018, lo sciatore Gus Kenworthy ha attirato l'attenzione mondiale per un gesto alle Olimpiadi Invernali di Pyeongchang. Di cosa si trattava?",
                    options: [
                        { text: "Un bacio in diretta TV al suo compagno", rationale: "È stato un momento storico di visibilità e spontaneità in un contesto sportivo globale molto seguito.", isCorrect: true },
                        { text: "Ha gareggiato indossando un tutù arcobaleno", rationale: "Gus ha gareggiato con la divisa ufficiale della sua nazionale.", isCorrect: false },
                        { text: "Ha rifiutato di ritirare la medaglia d'argento", rationale: "Non c'è stato alcun rifiuto della medaglia per motivi legati all'orientamento sessuale.", isCorrect: false },
                        { text: "Ha portato un gatto randagio sul podio", rationale: "Gus è noto per aver salvato dei cani in Russia, ma il gesto simbolico del 2018 riguardava la sua vita affettiva.", isCorrect: false }
                    ]
                },
                {
                    id: 10,
                    question: "Cosa rappresentano i 'Rainbow Laces' (lacci arcobaleno) spesso indossati dagli atleti in varie discipline?",
                    options: [
                        { text: "Una campagna per l'inclusione della comunità LGBT+ nello sport", rationale: "Nata nel Regno Unito, l'iniziativa invita gli atleti a mostrare solidarietà attraverso questo piccolo ma visibile dettaglio.", isCorrect: true },
                        { text: "Un nuovo standard obbligatorio per le scarpe da corsa", rationale: "Non esiste alcun obbligo tecnico che imponga i colori arcobaleno per i lacci.", isCorrect: false },
                        { text: "Il simbolo di chi ha vinto più di dieci medaglie", rationale: "Le medaglie e i lacci sono simboli completamente distinti.", isCorrect: false },
                        { text: "Una decorazione usata solo durante il mese di dicembre", rationale: "Sebbene siano più comuni durante i Pride Month, vengono usati tutto l'anno per diverse campagne di sensibilizzazione.", isCorrect: false }
                    ]
                }
            ]
        };

        const COLORS = ['bg-[#e30613]', 'bg-[#0054a6]', 'bg-[#009640]', 'bg-[#ffde00]'];

        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(() => sessionStorage.getItem('activeRole'));
            const [roomCode, setRoomCode] = useState(() => sessionStorage.getItem('activeRoom') || '');
            const [playerName, setName] = useState(() => sessionStorage.getItem('activePlayerName') || '');
            const [gameState, setGameState] = useState(null);
            const [players, setPlayers] = useState([]);
            const [displayedPlayers, setDisplayedPlayers] = useState([]);
            const [hasAnswered, setHasAnswered] = useState(false);
            const [lastAnswerCorrect, setLastAnswerCorrect] = useState(null);
            const [lastPointsEarned, setLastPointsEarned] = useState(0);
            const [errorMessage, setErrorMessage] = useState('');
            const [timeLeft, setTimeLeft] = useState(TIMER_SECONDS);
            const [prevScore, setPrevScore] = useState(0);

            // Sync QR e Auth
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const r = params.get('room');
                if (r && !roomCode) setRoomCode(r.toUpperCase());

                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (!u) await auth.signInAnonymously();
                    else {
                        setUser(u);
                        if (roomCode && !playerName) {
                            const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(`${roomCode}_${u.uid}`).get();
                            if (snap.exists) {
                                const d = snap.data();
                                setRole('player');
                                setName(d.name);
                                setPrevScore(d.score);
                                sessionStorage.setItem('activeRole', 'player');
                                sessionStorage.setItem('activePlayerName', d.name);
                                sessionStorage.setItem('activeRoom', roomCode);
                            }
                        }
                    }
                });
                return () => unsub();
            }, [roomCode, playerName]);

            // Database Sync
            useEffect(() => {
                if (!user || !roomCode || !role) return;
                const code = roomCode.trim().toUpperCase();
                const unsubRoom = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code).onSnapshot(s => {
                    if (s.exists) setGameState(s.data());
                    else if (role === 'player') setErrorMessage("Stanza chiusa.");
                });
                const unsubPlayers = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').onSnapshot(snap => {
                    const all = snap.docs.map(d => d.data()).filter(p => p.roomCode === code).sort((a,b) => b.score - a.score);
                    setPlayers(all);
                });
                return () => { unsubRoom(); unsubPlayers(); };
            }, [user, roomCode, role]);

            // Aggiornamento differito Classifica e Score Header
            useEffect(() => {
                if (!gameState) return;
                if (gameState.status === 'lobby' || gameState.showResults || gameState.status === 'finished') {
                    setDisplayedPlayers(players);
                    const me = players.find(p => p.uid === user?.uid);
                    if (me) setPrevScore(me.score);
                }
            }, [players, gameState?.showResults, gameState?.status, user?.uid]);

            // Timer
            useEffect(() => {
                if (gameState?.status === 'playing' && !gameState.showResults && gameState.questionStartTime) {
                    const timer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - gameState.questionStartTime) / 1000);
                        const remaining = Math.max(0, TIMER_SECONDS - elapsed);
                        setTimeLeft(remaining);
                        if (remaining === 0) {
                            clearInterval(timer);
                            if (role === 'player' && !hasAnswered) setHasAnswered(true);
                        }
                    }, 500);
                    return () => clearInterval(timer);
                }
            }, [gameState, role, hasAnswered]);

            // Reset Round
            useEffect(() => {
                if (gameState && !gameState.showResults) {
                    setHasAnswered(false);
                    setLastAnswerCorrect(null);
                    setLastPointsEarned(0);
                    setTimeLeft(TIMER_SECONDS);
                }
            }, [gameState?.currentQuestionIndex, gameState?.showResults]);

            const submitAnswer = async (i) => {
                if (hasAnswered || timeLeft === 0 || !gameState || gameState.showResults) return;
                const isCorrect = QUIZ_DATA.questions[gameState.currentQuestionIndex].options[i].isCorrect;
                const timeTaken = (Date.now() - gameState.questionStartTime) / 1000;
                const earned = isCorrect ? Math.floor(500 + (500 * (1 - Math.min(1, timeTaken/TIMER_SECONDS)))) : 0;
                setHasAnswered(true);
                setLastAnswerCorrect(isCorrect);
                setLastPointsEarned(earned);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(`${roomCode}_${user.uid}`).update({
                    score: firebase.firestore.FieldValue.increment(earned),
                    lastAnswerIndex: i, lastQuestionIndexAnswered: gameState.currentQuestionIndex, lastAnsweredAt: Date.now()
                });
            };

            const getQrUrl = () => {
                const joinUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
                return `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(joinUrl)}&bgcolor=ffffff&color=0054a6&margin=10`;
            };

            const rankInfo = useMemo(() => {
                const idx = displayedPlayers.findIndex(p => p.uid === user?.uid);
                const me = displayedPlayers[idx];
                // Mostra monete per punteggio 0
                if (!me || me.score === 0) return { label: idx !== -1 ? (idx + 1).toString() : "-", color: "text-white", icon: "coins" };
                
                if (idx === 0) return { label: "1", color: "text-[#ffd700]", icon: "trophy" };
                if (idx === 1) return { label: "2", color: "text-[#c0c0c0]", icon: "trophy" };
                if (idx === 2) return { label: "3", color: "text-[#cd7f32]", icon: "trophy" };
                return { label: (idx + 1).toString(), color: "text-white", icon: "coins" };
            }, [displayedPlayers, user]);

            const isFastestPlayer = useMemo(() => {
                if (!gameState?.showResults) return false;
                const correct = players.filter(p => p.lastQuestionIndexAnswered === gameState.currentQuestionIndex && QUIZ_DATA.questions[gameState.currentQuestionIndex].options[p.lastAnswerIndex]?.isCorrect);
                if (correct.length === 0) return false;
                const minTime = Math.min(...correct.map(p => p.lastAnsweredAt));
                return players.find(p => p.uid === user?.uid)?.lastAnsweredAt === minTime && lastAnswerCorrect;
            }, [players, gameState, lastAnswerCorrect, user]);

            // --- UI ---

            if (!role) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6 animate-fade-in text-center font-black">
                    <div className="bg-white p-10 rounded-3xl shadow-xl border w-full max-w-md">
                        <LogoArcigay className="h-24 mx-auto mb-6" />
                        <h1 className="text-3xl text-[#0054a6] uppercase mb-10 leading-tight">Pride House Quiz</h1>
                        <div className="space-y-5">
                            <input type="text" placeholder="Nome Squadra" className="w-full border-2 p-4 rounded-2xl text-center text-xl font-bold" value={playerName} onChange={e => setName(e.target.value)} />
                            <input type="text" placeholder="Codice Stanza" className="w-full border-2 p-4 rounded-2xl text-center uppercase text-2xl font-mono" value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                            <button onClick={async () => {
                                const cleanName = playerName.trim();
                                const cleanCode = roomCode.trim().toUpperCase();
                                if (!cleanName || !cleanCode) return;
                                const room = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(cleanCode).get();
                                if (room.exists) {
                                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players').doc(`${cleanCode}_${user.uid}`).set({
                                        uid: user.uid, name: cleanName, roomCode: cleanCode, score: 0, lastAnswerIndex: -1, lastQuestionIndexAnswered: -1, lastAnsweredAt: 0
                                    });
                                    sessionStorage.setItem('activeRoom', cleanCode);
                                    sessionStorage.setItem('activeRole', 'player');
                                    sessionStorage.setItem('activePlayerName', cleanName);
                                    setRole('player');
                                }
                            }} className="w-full bg-[#0054a6] text-white p-5 rounded-2xl uppercase text-xl transition-all active:scale-95 shadow-md">Partecipa</button>
                            <button onClick={async () => {
                                const code = Math.random().toString(36).substring(2,6).toUpperCase();
                                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(code).set({
                                    code, status: 'lobby', currentQuestionIndex: 0, showResults: false, hostId: user.uid, createdAt: Date.now(), questionStartTime: 0
                                });
                                sessionStorage.setItem('activeRoom', code);
                                sessionStorage.setItem('activeRole', 'host');
                                setRoomCode(code);
                                setRole('host');
                            }} className="w-full text-[#0054a6] border-2 border-[#0054a6] p-3 rounded-2xl text-sm uppercase">Crea Stanza Host</button>
                        </div>
                    </div>
                </div>
            );

            if (role === 'host' && gameState) {
                const q = QUIZ_DATA.questions[gameState.currentQuestionIndex];
                const answeredCount = players.filter(p=>p.lastQuestionIndexAnswered === gameState.currentQuestionIndex).length;
                return (
                    <div className="h-screen flex flex-col bg-gray-50 overflow-hidden font-black">
                        <header className="flex justify-between items-center bg-white p-4 border-b">
                            <LogoArcigay className="h-14" />
                            <div className="bg-[#0054a6] text-white px-5 py-2 rounded-full flex gap-3 items-center">
                                <Icon name="users" size={20}/> <span className="text-xl">{players.length}</span>
                            </div>
                        </header>
                        
                        <div className="flex-1 flex gap-6 p-6 overflow-hidden font-black">
                            <div className="flex-1 flex flex-col items-center justify-center text-center bg-white rounded-[3rem] shadow-xl border p-10 overflow-y-auto custom-scrollbar font-black">
                                {gameState.status === 'lobby' ? (
                                    <div className="flex flex-col items-center gap-8 w-full max-w-4xl font-black font-black">
                                        <h2 className="text-6xl text-[#0054a6] uppercase tracking-tighter">In attesa dei campioni...</h2>
                                        <div className="flex items-center justify-center p-8 bg-gray-50 rounded-[3rem] border-4 border-dashed border-gray-200 w-full max-w-md mx-auto shadow-inner">
                                            <div className="flex flex-col items-center">
                                                <img src={getQrUrl()} alt="QR" className="w-80 h-80 rounded-2xl mb-4" />
                                                <p className="text-4xl text-[#0054a6] font-mono tracking-widest leading-none">{roomCode}</p>
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2 justify-center max-w-2xl font-black font-black">
                                            {players.map(p => <div key={p.uid} className="bg-[#0054a6] text-white px-4 py-2 rounded-full text-sm animate-fade-in">{p.name}</div>)}
                                            {players.length === 0 && <p className="text-gray-400 italic font-black">In attesa dei collegamenti...</p>}
                                        </div>
                                        <button onClick={() => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomCode).update({status:'playing', questionStartTime: Date.now()})} className="bg-[#0054a6] text-white px-12 py-5 rounded-2xl text-2xl uppercase transition-all active:scale-95 shadow-xl">Inizia Quiz</button>
                                    </div>
                                ) : (
                                    <div className="w-full max-w-5xl space-y-8 font-black font-black font-black font-black">
                                        <div className="flex justify-between items-center">
                                            <span className="bg-[#0054a6] text-white px-6 py-2 rounded-full uppercase text-sm shadow-md">Domanda {gameState.currentQuestionIndex+1} / 10</span>
                                            {!gameState.showResults && <div className="text-4xl font-mono bg-gray-900 text-white px-8 py-3 rounded-2xl shadow-lg">{timeLeft}s</div>}
                                        </div>
                                        <h2 className={`text-[#0054a6] leading-tight tracking-tight text-justify ${gameState.showResults ? 'text-4xl' : 'text-7xl mt-10 mb-20'}`}>{q.question}</h2>
                                        <div className={`grid gap-4 ${gameState.showResults ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-2'}`}>
                                            {q.options.map((o, i) => (
                                                <div key={i} className="flex flex-col gap-3 font-black font-black">
                                                    <div className={`p-6 rounded-[2rem] border-4 flex items-center gap-4 transition-all ${gameState.showResults ? (o.isCorrect ? 'border-green-500 bg-green-50' : 'opacity-30 grayscale border-gray-100') : 'bg-gray-50 border-transparent shadow-inner font-black'}`}>
                                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${COLORS[i]} text-white text-2xl shadow-lg`}>{String.fromCharCode(65+i)}</div>
                                                        <span className="text-[#0054a6] text-2xl text-left font-bold leading-tight font-black">{o.text}</span>
                                                        {gameState.showResults && o.isCorrect && <Icon name="checkCircle" size={32} className="text-green-500 ml-auto" />}
                                                    </div>
                                                    {gameState.showResults && (
                                                        <div className={`px-8 py-5 rounded-3xl text-xl text-justify font-black ${o.isCorrect ? 'bg-[#009640]/10 text-[#009640] border border-[#009640]/20' : 'bg-gray-100 text-gray-500 border border-gray-200'}`}>
                                                            <p className="font-bold leading-tight">{o.rationale}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => {
                                            if (gameState.showResults) {
                                                if (gameState.currentQuestionIndex === 9) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomCode).update({status:'finished'});
                                                else db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomCode).update({currentQuestionIndex: firebase.firestore.FieldValue.increment(1), showResults: false, questionStartTime: Date.now()});
                                            } else db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomCode).update({showResults:true});
                                        }} className="w-full bg-[#0054a6] text-white py-5 rounded-2xl text-3xl uppercase font-black shadow-2xl active:scale-95 flex items-center justify-center gap-4 transition-all font-black font-black">
                                            {gameState.showResults ? (gameState.currentQuestionIndex === 9 ? "Podio Finale" : "Prossima Domanda") : "Rivela Risposte"} <Icon name="chevronRight" size={32} />
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="w-64 flex flex-col gap-4 font-black font-black font-black">
                                <div className="bg-white p-4 rounded-[2rem] shadow-xl border flex flex-col items-center">
                                    <img src={getQrUrl()} alt="QR" className="w-full rounded-xl mb-2" />
                                    <p className="text-xl font-mono text-[#0054a6] leading-none">{roomCode}</p>
                                </div>
                                {(gameState.status === 'lobby' || gameState.showResults) && (
                                    <div className="bg-white p-6 rounded-[2rem] shadow border flex-1 overflow-hidden flex flex-col font-black">
                                        <h3 className="text-xs text-gray-400 uppercase mb-4 border-b pb-2 tracking-widest font-black">Classifica</h3>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 font-black font-black">
                                            {displayedPlayers.map((p, i) => (
                                                <div key={p.uid} className={`flex justify-between p-2 rounded-lg ${i<3 ? 'bg-blue-50 text-[#0054a6]' : ''}`}>
                                                    <span className="truncate max-w-[100px] text-xs font-bold">{i+1}. {p.name}</span>
                                                    <span className="font-mono font-bold text-xs">{p.score}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {gameState.status === 'finished' && (
                            <div className="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center p-10 animate-fade-in text-center font-black">
                                <Icon name="crown" size={120} className="text-[#ffde00] mb-6 animate-bounce" />
                                <h2 className="text-7xl text-[#0054a6] mb-12 uppercase italic tracking-tighter">I Vincitori!</h2>
                                <div className="flex items-end gap-10 w-full max-w-4xl h-72 font-black font-black font-black font-black">
                                    {displayedPlayers[1] && <div className="flex-1 flex flex-col items-center font-black"><p className="text-xl mb-2 text-[#0054a6] uppercase truncate w-full">{displayedPlayers[1].name}</p><div className="w-full bg-gray-200 h-40 rounded-t-3xl flex items-center justify-center text-5xl text-gray-400 border-t-8 border-gray-300 shadow-xl">2</div></div>}
                                    {displayedPlayers[0] && <div className="flex-1 flex flex-col items-center font-black font-black font-black"><p className="text-3xl mb-4 text-[#0054a6] font-black uppercase truncate w-full drop-shadow-md">{displayedPlayers[0].name}</p><div className="w-full bg-gradient-to-b from-[#ffde00] to-[#e6c800] h-60 rounded-t-[3rem] flex items-center justify-center text-9xl text-[#0054a6] border-t-8 border-[#ffde00] shadow-2xl font-black font-black">1</div></div>}
                                    {displayedPlayers[2] && <div className="flex-1 flex flex-col items-center font-black font-black font-black"><p className="text-xl mb-2 text-[#0054a6] uppercase truncate w-full">{displayedPlayers[2].name}</p><div className="w-full bg-orange-100 h-32 rounded-t-3xl flex items-center justify-center text-5xl text-orange-300 border-t-8 border-orange-200 shadow-xl">3</div></div>}
                                </div>
                                <button onClick={() => {sessionStorage.clear(); window.location.reload();}} className="mt-16 px-16 py-5 bg-gray-900 text-white rounded-full text-xl uppercase tracking-widest shadow-xl transition-all hover:bg-black font-black font-black">Nuova Partita</button>
                            </div>
                        )}
                    </div>
                );
            }

            if (role === 'player' && gameState) return (
                <div className="min-h-screen bg-white text-[#0054a6] flex flex-col font-black overflow-hidden animate-fade-in text-center font-black font-black font-black">
                    <header className="p-4 bg-white border-b-4 border-[#ffde00] flex justify-between items-center shadow-md font-black font-black font-black font-black font-black font-black font-black font-black">
                        <LogoArcigay className="h-10 font-black font-black font-black" />
                        <div className="bg-[#0054a6] px-4 py-1.5 rounded-full flex items-center gap-3 text-white font-black shadow-sm font-black font-black font-black font-black font-black font-black">
                            <div className="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full shrink-0 font-black font-black font-black font-black font-black font-black font-black">
                                <Icon name={rankInfo.icon} size={18} className={rankInfo.color} />
                            </div>
                            <span className="text-xl font-mono leading-none font-black font-black font-black font-black font-black font-black font-black font-black font-black">{prevScore}</span>
                        </div>
                    </header>

                    <main className="flex-1 p-4 flex flex-col items-center justify-center bg-gray-50 font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                        {gameState.status === 'lobby' && (
                            <div className="space-y-6 animate-fade-in max-w-xs flex flex-col items-center font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">
                                <LogoPrideHouse className="h-40 w-auto object-contain mx-auto mb-4 font-black font-black font-black font-black font-black font-black" />
                                <h2 className="text-2xl uppercase tracking-tighter leading-tight font-black font-black font-black font-black font-black">IL QUIZ STA PER INIZIARE!</h2>
                                <p className="text-gray-500 text-sm italic tracking-widest font-black font-black font-black font-black font-black font-black font-black font-black">Player: {playerName}</p>
                            </div>
                        )}

                        {gameState.status === 'playing' && !gameState.showResults && (
                            <div className="w-full max-w-sm flex flex-col gap-6 h-full py-4 font-black font-black font-black font-black font-black">
                                <div className="flex items-center justify-center gap-3 font-black font-black font-black">
                                    <Icon name="clock" size={28} className={timeLeft < 10 ? 'text-red-500 animate-pulse font-black' : 'text-[#0054a6] font-black'} />
                                    <span className={`text-5xl font-mono font-black font-black font-black font-black ${timeLeft < 10 ? 'text-red-500 font-black' : 'text-[#0054a6] font-black'}`}>{timeLeft}s</span>
                                </div>
                                {hasAnswered ? (
                                    <div className="flex-1 flex flex-col items-center justify-center bg-white border-4 border-dashed border-[#0054a6]/20 rounded-[3rem] shadow-inner animate-pulse p-10 font-black font-black font-black">
                                        <Icon name="loader2" size={64} className="animate-spin text-[#0054a6]/40 mb-4 font-black font-black font-black" />
                                        <h2 className="text-4xl uppercase text-[#0054a6]/60 leading-none font-black font-black font-black">Acquisita</h2>
                                        <p className="text-gray-400 mt-4 text-sm tracking-[0.2em] uppercase font-black font-black font-black">Guarda lo schermo principale</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 gap-5 flex-1 font-black font-black font-black">
                                        {COLORS.map((c, i) => (
                                            <button key={i} onClick={() => submitAnswer(i)} className={`flex-1 rounded-[2.5rem] ${c} shadow-2xl text-6xl text-white border-b-8 border-black/20 uppercase active:translate-y-2 active:shadow-none transition-all font-black font-black font-black`}>
                                                {String.fromCharCode(65 + i)}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {gameState.status === 'playing' && gameState.showResults && (
                            <div className={`w-full max-w-[320px] p-6 rounded-[3.5rem] flex flex-col items-center justify-center text-center shadow-xl border-b-4 animate-in zoom-in text-white transition-colors duration-500 font-black font-black font-black ${lastAnswerCorrect === true ? 'bg-[#009640] border-[#007030]' : 'bg-[#e30613] border-[#b0050f]'}`}>
                                <div className="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-inner text-white font-black font-black font-black shrink-0">
                                    <Icon name={lastAnswerCorrect === true ? "checkCircle" : "xCircle"} size={48} />
                                </div>
                                <h2 className="text-3xl uppercase mb-4 leading-none font-black font-black font-black text-center font-black">
                                    {lastAnswerCorrect === true ? 'ESATTO!' : (timeLeft === 0 && lastAnswerCorrect === null ? 'TEMPO SCADUTO' : 'ERRATO')}
                                </h2>
                                <div className="w-full space-y-4 font-black font-black font-black">
                                    {lastAnswerCorrect === true ? (
                                        <div className="flex flex-col items-center gap-1 font-black font-black font-black">
                                            <div className="flex items-center gap-3 font-black font-black font-black">
                                                {isFastestPlayer && <Icon name="zap" size={24} className="text-[#ffde00] fill-[#ffde00] animate-bounce font-black font-black" />}
                                                <span className="text-2xl font-black font-black font-black font-black">+{lastPointsEarned} PT</span>
                                            </div>
                                            {isFastestPlayer && <p className="text-[10px] text-[#ffde00] uppercase font-black font-black font-black animate-pulse tracking-[0.2em] font-black">VELOCITÀ MASSIMA!</p>}
                                        </div>
                                    ) : <div className="text-xl font-black font-black opacity-60 uppercase tracking-widest font-black font-black">0 PUNTI</div>}
                                    <div className="border-t border-white/20 pt-4 font-black font-black font-black">
                                        <p className="text-xs text-white/70 mb-1 uppercase tracking-widest font-black font-black">Classifica:</p>
                                        <p className={`text-6xl ${rankInfo.color} drop-shadow-sm font-black font-black font-black leading-none font-black`}>{rankInfo.label}{rankInfo.label !== "-" ? "°" : ""}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState.status === 'finished' && (
                            <div className="flex-1 flex flex-col items-center justify-center animate-fade-in max-w-[320px] font-black mx-auto font-black font-black text-center">
                                <div className="w-36 h-36 flex items-center justify-center bg-white rounded-full shadow-2xl border-4 border-[#0054a6]/10 font-black font-black font-black mb-8">
                                    <Icon name={rankInfo.icon} size={80} className={`drop-shadow-xl ${rankInfo.color} font-black font-black`} />
                                </div>
                                <h2 className="text-6xl uppercase tracking-tighter leading-tight font-black font-black font-black mb-10 font-black">GARA FINITA!</h2>
                                <div className="bg-white p-8 rounded-[3.5rem] border-2 border-gray-100 shadow-2xl w-full font-black font-black font-black text-center font-black">
                                    <p className="text-xs text-gray-400 uppercase tracking-widest mb-3 font-black font-black font-black">Punteggio Finale</p>
                                    <p className="text-2xl text-[#0054a6] mb-3 font-black font-black font-black font-black font-black leading-none">{rankInfo.label}° Posto</p>
                                    <p className="text-7xl font-mono text-[#0054a6] leading-none tracking-tighter font-black font-black font-black font-black font-black mt-2">{players.find(p=>p.uid===user?.uid)?.score || 0}</p>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>